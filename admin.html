<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create - Panel de Administraci칩n</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">游닄 Mi Galer칤a</a>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="admin.html" class="nav-link active">Create</a></li>
                <li><a href="#" class="nav-link" id="authLink">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="admin-container">
        <h1>九꽲잺 Crear Nueva Entrada</h1>
        
        <div id="message"></div>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="title">T칤tulo</label>
                <input type="text" id="title" required placeholder="T칤tulo de tu historia">
            </div>
            
            <div class="form-group">
                <label for="description">Descripci칩n</label>
                <textarea id="description" required placeholder="Escribe aqu칤 tu historia o descripci칩n..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="imageInput">Imagen</label>
                <input type="file" id="imageInput" accept="image/*" required>
                <div id="preview" class="preview"></div>
            </div>
            
            <button type="submit" class="btn">Publicar Entrada</button>
        </form>
        
        <div class="gallery-list">
            <h2>Mis Entradas</h2>
            <div id="currentGallery"></div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script>
        // Verificar autenticaci칩n
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            alert('Debes iniciar sesi칩n para acceder a esta p치gina');
            window.location.href = 'login.html';
        }
        
        const authLink = document.getElementById('authLink');
        authLink.onclick = function(e) {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        };
        
        // Preview de la imagen
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('preview').innerHTML = 
                        `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });
        
        async function loadCurrentGallery() {
    try {
        const gallery = await getGallery();
        const container = document.getElementById('currentGallery');
        
        if (!Array.isArray(gallery) || gallery.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #9B9B9B; padding: 40px;">No hay entradas todav칤a</p>';
            return;
        }
        
        container.innerHTML = gallery.map((item, index) => `
            <div class="gallery-item">
                <img src="${item.image}" alt="${item.title}">
                <div class="gallery-item-content">
                    <h3>${item.title}</h3>
                    <p>${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</p>
                </div>
                <button class="btn-delete" onclick="deleteItem(${index})">Eliminar</button>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error cargando galer칤a:', error);
    }
}
        
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const imageInput = document.getElementById('imageInput');
    
    if (imageInput.files.length === 0) {
        showMessage('Por favor selecciona una imagen', false);
        return;
    }
    
    // Mostrar mensaje de carga
    showMessage('Procesando imagen...', true);
    
    const file = imageInput.files[0];
    
    // Comprimir la imagen
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = new Image();
        img.onload = async function() {
            // Crear canvas para redimensionar
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calcular nuevas dimensiones (m치ximo 800px de ancho)
            let width = img.width;
            let height = img.height;
            const maxWidth = 800;
            
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dibujar imagen redimensionada
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convertir a base64 con calidad reducida
            const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
            
            console.log('Tama침o original:', event.target.result.length);
            console.log('Tama침o comprimido:', compressedImage.length);
            
            const newItem = {
                title: title,
                description: description,
                image: compressedImage,
                date: new Date().toISOString()
            };
            
            try {
    showMessage('Subiendo imagen...', true);
    await addToGallery(newItem);
    
    // Limpiar cach칠 para forzar actualizaci칩n
    localStorage.removeItem('cachedGallery');
    
    showMessage('춰Entrada publicada! Redirigiendo...', true);
    
    // Esperar 1 segundo y redirigir al home
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1000);
    
} catch (error) {
    console.error('Error completo:', error);
    showMessage('Error al publicar. Verifica tu conexi칩n.', false);
}

        };
        img.src = event.target.result;
    };
    
    reader.readAsDataURL(file);
});

        
        function showMessage(msg, success) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="alert ${success ? 'alert-success' : 'alert-error'}">${msg}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }
        
        function deleteItem(index) {
            if (confirm('쮼st치s seguro de eliminar esta entrada?')) {
                let gallery = getGallery();
                gallery.splice(index, 1);
                localStorage.setItem('bookGallery', JSON.stringify(gallery));
                loadCurrentGallery();
                showMessage('Entrada eliminada', true);
            }
        }
        
        loadCurrentGallery();
    </script>
</body>
</html>
